<head>
	<style>
		* {
		  box-sizing: border-box;
		}

		/* Create two equal columns that floats next to each other */
		.column {
		  float: left;
		  width: 200px;
		  padding: 10px;
		}

		/* Clear floats after the columns */
		.row:after {
		  content: "";
		  display: table;
		  clear: both;
		}

		.main {
			width:  1200px;
		}
	</style>
<script type="module">
	import { GitHubHandler } from './GitHubHandler.js';
	import { JiraHandler } from './JiraHandler.js'
	import { DataCombiner } from './DataCombiner.js'

	const owner = localStorage.getItem('OWNER');
	const repo = localStorage.getItem('REPO');
	const token = localStorage.getItem('TOKEN');


	function clearColumns() {
		document.getElementById('in-dev').innerHTML = "In Dev | "
		document.getElementById('review').innerHTML = "Review | "
		document.getElementById('awaiting-merge').innerHTML = "Awaiting Merge | "
	}

	function drawBranchesFromFilter(task, taskId, filter, elementId) {
		const branches = task.branches;
		var devTasks = branches.filter(filter);
		const isJira = task.taskInfo ? "" : "- No Jira";
		if (devTasks.length > 0) {
			document.getElementById(elementId).innerHTML += "<div>" + taskId + "(" + devTasks.length + ")" + isJira + "</div>"
		}
	}

	function drawBranchesFromTask(task, taskId) {
		drawBranchesFromFilter(task, taskId, ((branch) => branch.location === 'DEV'), 'in-dev')
		drawBranchesFromFilter(task, taskId, ((branch) => branch.location === 'PR'), 'review')
		drawBranchesFromFilter(task, taskId, ((branch) => branch.location === 'AM'), 'awaiting-merge')
		//TODO: There is worry here that we could silently lose branches if they are in an unmapped state. We should log if there is a branch that doesn't match any of these filters.
		
	}

	function drawColumns() {
		clearColumns();
		dataCombiner.tasks.forEach((task, taskId) => {
			if (task.branches.length == 0) {
				document.getElementById('todo').innerHTML += "<div>" + taskId + "</div>"
			} else {
				drawBranchesFromTask(task, taskId)
			}
		})
		dataCombiner.unknowns.forEach((unknown) => {
			document.getElementById('review').innerHTML += "<div>UNKNOWN: " + unknown.name + "</div>"
		})

		
	}

	
	const gitHubHandler = new GitHubHandler(owner, repo, token);
	const jiraHandler = new JiraHandler();
	const dataCombiner = new DataCombiner(jiraHandler, gitHubHandler, drawColumns);

</script>
</head>
<body>
	<div class="main">
		<div id="todo" class="column">Todo</div>
		<div id="in-dev" class="column">In Dev | </div>
		<div id="review" class="column"> | </div>
		<div id="awaiting-merge" class="column">Awaiting Merge</div>
		<div id="done" class="column">Done</div>
	</div>
</body>
