<head>
	<style>
		* {
		  box-sizing: border-box;
		}

		/* Create two equal columns that floats next to each other */
		.column {
		  float: left;
		  width: 200px;
		  padding: 10px;
		}

		/* Clear floats after the columns */
		.row:after {
		  content: "";
		  display: table;
		  clear: both;
		}

		.main {
			width:  1200px;
		}
	</style>
<script type="module">
	import { GitHubHandler } from './GitHubHandler.js';
	import { GitHubClosedHandler } from './GitHubClosedHandler.js';
	import { JiraHandler } from './JiraHandler.js'
	import { DataCombiner } from './DataCombiner.js'

	const owner = localStorage.getItem('OWNER');
	const repo = localStorage.getItem('REPO');
	const repo2 = localStorage.getItem('REPO2');
	const token = localStorage.getItem('TOKEN');


	function clearColumns() {
		document.getElementById('in-dev').innerHTML = "In Dev | "
		document.getElementById('review').innerHTML = "Review | "
		document.getElementById('awaiting-merge').innerHTML = "Awaiting Merge | "
	}

	function drawBranchesFromFilter(task, taskId, filter, elementId) {
		const branches = task.branches;
		var devTasks = branches.filter(filter);
		const isJira = task.taskInfo ? "" : "- No Jira";
		if (devTasks.length > 0) {
			document.getElementById(elementId).innerHTML += "<div>" + taskId + "(" + devTasks.length + ")" + isJira + "</div>"
		}
	}

	function drawDev(task, taskId, filter, elementId, unmatchedElementId) {
		const branches = task.branches;
		var devTasks = branches.filter(filter);
		if (task.taskInfo) {
			if (devTasks.length > 0) {
				document.getElementById(elementId).innerHTML += "<div>" + taskId + "(" + devTasks.length + ")</div>"
			}
		} else {
			if (devTasks.length > 0) {
				document.getElementById(unmatchedElementId).innerHTML += "<div>" + taskId + "(" + devTasks.length + ")</div>"
			}
		}

	}

	function drawBranchesFromTask(task, taskId) {
		//drawBranchesFromFilter(task, taskId, ((branch) => branch.location === 'DEV'), 'in-dev')
		drawDev(task, taskId, ((branch) => branch.location === 'DEV'), 'in-dev', 'in-dev-unmatched');
		drawDev(task, taskId, ((branch) => branch.location === 'PR'), 'review', 'review-unmatched');
		//drawBranchesFromFilter(task, taskId, ((branch) => branch.location === 'PR'), 'review');
		drawDev(task, taskId, ((branch) => branch.location === 'AM'), 'awaiting-merge', 'awaiting-merge-unmatched');
		drawDev(task, taskId, ((branch) => branch.location === 'CLOSED'), 'done', 'done-unmatched');
		//drawBranchesFromFilter(task, taskId, ((branch) => branch.location === 'AM'), 'awaiting-merge');
		//TODO: There is worry here that we could silently lose branches if they are in an unmapped state. We should log if there is a branch that doesn't match any of these filters.
		
	}

	function drawColumns() {
		clearColumns();
		dataCombiner.tasks.forEach((task, taskId) => {
			if (task.branches.length == 0) {
				document.getElementById('todo').innerHTML += "<div>" + taskId + "</div>"
			} else {
				drawBranchesFromTask(task, taskId)
			}
		})
		dataCombiner.unknowns.forEach((unknown) => {
			document.getElementById('review-unmatched').innerHTML += "<div>UNKNOWN: " + unknown.name + "</div>"
		})
		dataCombiner.closedTasks.forEach((closedTask) => {
			document.getElementById('done').innerHTML += "<div>" + closedTask.title + "</div>"
		})
	}


	
	const gitHubHandler = new GitHubHandler(owner, repo, token);
	const gitHubHandler2 = new GitHubHandler(owner, repo2, token);
	const gitHubClosedHandler = new GitHubClosedHandler(owner, repo, token);
	const gitHubClosedHandler2 = new GitHubClosedHandler(owner, repo2, token);
	const jiraHandler = new JiraHandler();
	const dataCombiner = new DataCombiner(jiraHandler, [gitHubHandler, gitHubHandler2], [gitHubClosedHandler, gitHubClosedHandler2], drawColumns);

</script>
<script type="text/javascript">
	function toggleDisplayUnmatchedDev() {
		var x = document.getElementById("in-dev-unmatched");
		if (x.style.display === "none") {
			x.style.display = "inline";
		} else {
			x.style.display = "none";
		}
	}
	function toggleDisplayUnmatchedReview() {
		var x = document.getElementById("review-unmatched");
		if (x.style.display === "none") {
			x.style.display = "inline";
		} else {
			x.style.display = "none";
		}
	}
	function toggleDisplayUnmatchedAwaitingMerge() {
		var x = document.getElementById("awaiting-merge-unmatched");
		if (x.style.display === "none") {
			x.style.display = "inline";
		} else {
			x.style.display = "none";
		}
	}
	function toggleDisplayUnmatchedDone() {
		var x = document.getElementById("done-unmatched");
		if (x.style.display === "none") {
			x.style.display = "inline";
		} else {
			x.style.display = "none";
		}
	}
</script>
</head>
<body>
	<div class="main">
		<div id="todo" class="column">Todo</div>
		<div  class="column">
			<div id="in-dev">In Dev | </div>
			<button type="button" onClick="toggleDisplayUnmatchedDev()">Toggle Unmatched</button>
			<div id="in-dev-unmatched" style="display: none;"></div>
		</div>
		<div  class="column">
			<div id="review">Review | </div>
			<button type="button" onClick="toggleDisplayUnmatchedReview()">Toggle Unmatched</button>
			<div id="review-unmatched" style="display: none;"></div>
		</div>
		<div  class="column">
			<div id="awaiting-merge">Awaiting Merge</div>
			<button type="button" onClick="toggleDisplayUnmatchedAwaitingMerge()">Toggle Unmatched</button>
			<div id="awaiting-merge-unmatched" style="display: none;"></div>
		</div>

		<div  class="column">
			<div id="done">Done</div>
			<button type="button" onClick="toggleDisplayUnmatchedDone()">Toggle Unmatched</button>
			<div id="done-unmatched" style="display: none;"></div>
		</div>
	</div>
</body>
